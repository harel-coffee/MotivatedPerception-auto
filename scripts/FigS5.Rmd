---
title: "Salience and Attention networks"
output: html_document
---

```{r set-up, warning=FALSE, message=FALSE, results="hide"}
# Clear workspace
rm(list = ls())

# Load helper functions
source('helper_functions.R')

# Import libraries
packages = c("tidyr","dplyr","ggplot2","lme4","lmerTest","Hmisc","car","lmtest","Rarity","cowplot")
ipak(packages)

# Redo long calculations
redo_calc = 0;

```

```{r load-data}
# which rois to run
rois = c("accumbens", "insula_harvard", "dACC_grecius", "FEF_grecius","ips_grecius")
roi_names = c("NAcc", "insula", "dACC", "FEF", "IPS")

# Read data
AllData = read.csv("../data/AllData.csv")

# Convert to factors
AllData$Sub = as.factor(AllData$Sub)
AllData$Pred = as.factor(AllData$Pred)
AllData$Want2See = as.factor(AllData$Want2See)
AllData$Con_Rev = factor(AllData$Con, levels = c('Coop','Comp'))

AllData_ValidTrials = filter(AllData, !(is.na(Choice)))
AllData_ValidTrials$RT_Rev = as.numeric(as.character(AllData_ValidTrials$RT))
AllData_ValidTrials$RT_Rev[AllData_ValidTrials$MotCon == FALSE] = AllData_ValidTrials$RT_Rev[AllData_ValidTrials$MotCon == FALSE] * - 1

load("long_calc/ConditionxBet.Rda")

# Extract random slope of the interaction
intSlope = unlist(coef(res)$Sub$`ConCoop:Pred1`)

# Create dataframe for each subject's bias
SubBias= as.data.frame(intSlope)
SubBias$Sub = unique(AllData$Sub)

# Median split participant 
SubBias$medianBehav = SubBias$intSlope >
  median(SubBias$intSlope)

# Clean up dataframe. 
SubBias = select(SubBias,Sub,intSlope,medianBehav)

# Load ROI data
load("long_calc/featquery_z.Rda")

# rearrange columns 
featquery_res = select(featquery_res, Sub, accumbens, insula_harvard, dACC_grecius, FEF_grecius, ips_grecius)
```


```{r warning = F}
# Function to plot median splits
plot_mediansplit = function(SubBias,roi,roi_name){
  
  SubBias$V6 = SubBias[,roi]
  thisPlot = ggplot(SubBias,aes(x=medianBehav,y=V6)) +
  stat_summary(fun.y=mean,geom="bar", width = 0.3) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "errorbar",width=0.1) +
  geom_hline(yintercept = 0) +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line.x = element_blank(),
        axis.text.x  = element_text(size=12,color="black"),
        axis.text.y  = element_text(size=12,color="black"),
        axis.title.x=element_blank()) + 
    ylab("z-stat") +
  coord_cartesian(ylim=c(-0.2, 0.65)) +
  scale_x_discrete(labels = c('High Bias','Low Bias')) + ggtitle(roi_name)

  return(thisPlot)
}

# Function to run trial by trial correlation
trial_by_trial = function(roi,BiaseData,UnbiasedData,SubBias){
  BiasedData$V6 = BiasedData[,roi] 
  UnbiasedData$V6 = UnbiasedData[,roi] 
  
  #Biased Subjects
  res.bias = glmer(Choice ~ Cat_n_z + Want2See * V6 + (Want2See * V6|Sub), family = "binomial", BiasedData, control = glmerControl(optimizer = 'bobyqa'))
  
  #Unbiased Subjects
  res.unbias = glmer(Choice ~ Cat_n_z + Want2See * V6 + (Want2See * V6|Sub), family = "binomial", UnbiasedData, control = glmerControl(optimizer = 'bobyqa'))

  output = NULL
  output$res.bias = res.bias
  output$res.unbias = res.unbias
  
  return(output)
}

# Function to plot trial-by-trial correlation
plot.trial.by.trial = function(res.bias, res.unbias, BiasedData, UnbiasedData, AllData, roi){
  
  BiasedData$V6 = BiasedData[,roi] 
  UnbiasedData$V6 = UnbiasedData[,roi] 
  
  # Create simulated data
  Want2See = c(0,1)
  V6 = seq(-4, 4, len = 100)
  Cat_n_z = AllData$Cat_n_z[AllData$Sub == 2013]
  
  pred.data = merge(Want2See,V6, by = NULL)
  pred.data = merge(pred.data,Cat_n_z,by = NULL)

  colnames(pred.data) = c("Want2See", "V6", "Cat_n_z")
  pred.data$Want2See = as.factor(pred.data$Want2See)

  temp = summary(res.bias)$coefficients
  
  pred.data$pred_raw = 
  temp['(Intercept)','Estimate'] + 
  temp['Cat_n_z','Estimate'] * pred.data$Cat_n_z +
  temp['Want2See1','Estimate'] * as.numeric(as.character(pred.data$Want2See)) +
  temp['V6','Estimate'] * pred.data$V6 +
  temp['Want2See1:V6','Estimate'] * (pred.data$V6 * as.numeric(as.character(pred.data$Want2See))) 
  
  pred.data$pred = 1/(1 + exp(-pred.data$pred_raw))
  
  # Biased Sub
  BiasedData$ChoiceJitter = BiasedData$Choice
  BiasedData$ChoiceJitter[as.logical(BiasedData$Choice)] = BiasedData$ChoiceJitter[as.logical(BiasedData$Choice)] - 0.05
  BiasedData$ChoiceJitter[!BiasedData$Choice] = BiasedData$ChoiceJitter[!BiasedData$Choice] + 0.05
  
  plot1 = ggplot(BiasedData, aes(x = V6, y = ChoiceJitter, col = Want2See)) + 
  geom_jitter(height = 0.05, alpha = 0.2) +
  stat_summary(data = pred.data, aes(x = V6, y = pred, col = Want2See), 
               fun.y=mean,geom="line",size=1.5) +
  scale_colour_manual(values=myPalette) +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x  = element_text(size=12,color="black"),
        axis.text.y  = element_text(size=12,color="black"),
        axis.title.y = element_text(size=12,color="black"),
        axis.title.x = element_text(size=12,color="black"),
        axis.line = element_line(colour = "black"),
        strip.background = element_blank(),
        strip.text.x = element_text(face = "bold"),
        plot.title = element_text(face = "plain", size = (12))) +
  coord_cartesian(ylim=c(0, 1), xlim=c(-4,4)) +
  xlab("z-stat") + ylab("P(Respond Scene)") +
  ggtitle("High Bias") 
  
  # Unbiased Sub
UnbiasedData$ChoiceJitter = UnbiasedData$Choice
UnbiasedData$ChoiceJitter[as.logical(UnbiasedData$Choice)] = UnbiasedData$ChoiceJitter[as.logical(UnbiasedData$Choice)] - 0.05
UnbiasedData$ChoiceJitter[!UnbiasedData$Choice] = UnbiasedData$ChoiceJitter[!UnbiasedData$Choice] + 0.05

temp = summary(res.unbias)$coefficients

pred.data$pred_raw = 
  temp['(Intercept)','Estimate'] + 
  temp['Cat_n_z','Estimate'] * pred.data$Cat_n_z +
  temp['Want2See1','Estimate'] * as.numeric(as.character(pred.data$Want2See)) +
  temp['V6','Estimate'] * pred.data$V6 +
  temp['Want2See1:V6','Estimate'] * (pred.data$V6 * as.numeric(as.character(pred.data$Want2See))) 
  
pred.data$pred = 1/(1 + exp(-pred.data$pred_raw))

plot2 = ggplot(UnbiasedData, aes(x = V6, y = ChoiceJitter, col = Want2See)) +
  geom_jitter(height = 0.05, alpha = 0.2) +
  stat_summary(data = pred.data, aes(x = V6, y = pred, col = Want2See),
               fun.y=mean,geom="line",size=1.5) +
  scale_colour_manual(values=myPalette) +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x  = element_text(size=12,color="black"),
        axis.text.y  = element_text(size=12,color="black"),
        axis.title.y = element_text(size=12,color="black"),
        axis.title.x = element_text(size=12,color="black"),
        axis.line = element_line(colour = "black"),
        strip.background = element_blank(),
        strip.text.x = element_text(face = "bold"),
                plot.title = element_text(face = "plain", size = (12))) +
  coord_cartesian(ylim=c(0, 1), xlim=c(-4,4)) +
  xlab("Z-Stat") + ylab("P(Respond Scene)") +
  ggtitle("Low Bias") 

  thisplot = 
    plot_grid(plot1,plot2, ncol = 2)
  return(thisplot)
}
```


```{r}
# Combine data-frames
SubBias_featquery = left_join(SubBias,featquery_res)
SubBias_featquery$medianBehav = factor(SubBias_featquery$medianBehav, levels = c("TRUE", "FALSE"))

# Plot median splits:
median_split = NULL
for (r in 2:5){
  median_split[[r]] = plot_mediansplit(SubBias_featquery,rois[r],roi_names[r])
}
```

```{r warning = F}
# Run trial-by-trial correlations 
BiasedData =  subset(AllData_ValidTrials, Sub %in% SubBias$Sub[SubBias$medianBehav == "TRUE"])
UnbiasedData = subset(AllData_ValidTrials, Sub %in% SubBias$Sub[SubBias$medianBehav == "FALSE"])

if (redo_calc){
  res.trial_by_trial = NULL
  
  for (r in 1:5){
    roi = rois[r]
    res.trial_by_trial[[r]] = trial_by_trial(roi,BiasedData,UnbiasedData,SubBias)
  }
  save(res.trial_by_trial,file="long_calc/res_trialBytrial.Rda")
}else {
  load("long_calc/res_trialBytrial.Rda")
}
```

```{r fig.width = 9, fig.height = 9, echo = F, warning = F}
# Run plots
trial.by.trial = NULL
for (r in 2:5){
  roi = rois[r]
  res.bias = res.trial_by_trial[[r]]$res.bias
  res.unbias = res.trial_by_trial[[r]]$res.unbias
  trial.by.trial[[r]] = plot.trial.by.trial(res.bias, res.unbias, BiasedData, UnbiasedData, AllData,roi)
}

# Plot full plot
median_plots = plot_grid(median_split[[2]],median_split[[3]],median_split[[4]],median_split[[5]], ncol = 1)
trial.by.trial_plots = plot_grid(trial.by.trial[[2]],trial.by.trial[[3]],trial.by.trial[[4]],trial.by.trial[[5]], ncol = 1)
  
plot_grid(median_plots,trial.by.trial_plots,ncol = 2)

```

**Relationship between motivational bias and activity in the salience and attention networks.** Unlike the NAcc, the average response of the insula, dACC, FEF and IPS to Motivation Consistent trials were not different between High vs. Low Bias participants (left). In the High Bias participants however, higher activity in the dACC, FEF, and IPS were associated with increased likelihood of making motivationally consistent categorizations at the trial-by-trial level. Single dots denote individual choices made by participants. Colored lines indicate probability of making a scene categorization as predicted by a linear mixed effects model (right).

```{r}
# Run stats for one ROI
# rois = c("accumbens", "insula_harvard", "dACC_grecius", "FEF_grecius","ips_grecius")
thisROI = rois[5]

# Median split
SubBias_featquery$V6 = SubBias_featquery[,thisROI]

t.test(V6 ~ medianBehav, SubBias_featquery, var.equal = T)

# Trial-by-trial correlation
BiasedData$V6 = BiasedData[,thisROI] 
UnbiasedData$V6 = UnbiasedData[,thisROI] 
  
#Biased Subjects
res.bias = glmer(Choice ~ Cat_n_z + Want2See * V6 + (Want2See * V6|Sub), family = "binomial", BiasedData, control = glmerControl(optimizer = 'bobyqa'))
  
#Unbiased Subjects
res.unbias = glmer(Choice ~ Cat_n_z + Want2See * V6 + (Want2See * V6|Sub), family = "binomial", UnbiasedData, control = glmerControl(optimizer = 'bobyqa'))

```

