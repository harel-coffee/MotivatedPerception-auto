---
title: "NAcc activity is associated with response bias"
output: html_document
---

```{r set-up, warning=FALSE, message=FALSE, results="hide"}
# Clear workspace
rm(list = ls())

# Load helper functions
source('helper_functions.R')

# Import libraries
packages = c("tidyr","dplyr","ggplot2","lme4","lmerTest","Hmisc","car","lmtest","Rarity","cowplot")
ipak(packages)

# Redo long calculations
redo_calc = 0;

```

### Load Data
```{r load-data}
# Read data
AllData = read.csv("../data/AllData.csv")

# Convert to factors
AllData$Sub = as.factor(AllData$Sub)
AllData$Pred = as.factor(AllData$Pred)
AllData$Want2See = as.factor(AllData$Want2See)
AllData$Con_Rev = factor(AllData$Con, levels = c('Coop','Comp'))
AllData_ValidTrials = filter(AllData, !(is.na(Choice)))

# Load psychometric results (see Fig. 2 code)
load("long_calc/ConditionxBet.Rda")
```

#### NAcc response to Motivation Consistent trials was higher in High Bias participants than Low Bias participants
```{r}
# Extract random slope of the interaction
intSlope = unlist(coef(res)$Sub$`ConCoop:Pred1`)

# Create datafrom for each subjec'ts bias, and order in descending order
SubBias_Striatum = as.data.frame(intSlope)
SubBias_Striatum$Sub = unique(AllData$Sub)

# Load in Striatum Betas
load("long_calc/featquery_z.Rda")
PE = select(featquery_res, Sub, accumbens) 

SubBias_Striatum = left_join(SubBias_Striatum ,PE) %>% 
  select(Sub,intSlope,accumbens)

# Median Split
SubBias_Striatum$medianBehav = SubBias_Striatum$intSlope > 
  median(SubBias_Striatum$intSlope)
SubBias_Striatum$medianBehav = factor(SubBias_Striatum$medianBehav, levels = c("TRUE", "FALSE"))

# T-test of all subjects against 0
t.test(SubBias_Striatum$accumbens, mu=0, var.equal = T)

# t-test High Bias vs. Low Bias
t.test(SubBias_Striatum$accumbens[SubBias_Striatum$medianBehav == "TRUE"],
       SubBias_Striatum$accumbens[SubBias_Striatum$medianBehav == "FALSE"], var.equal = T)

# Plot Median Split
plot.mediansplit = ggplot(SubBias_Striatum,aes(x=medianBehav,y=accumbens)) +
  stat_summary(fun.y=mean,geom="bar", width = 0.3) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1), geom = "errorbar",width=0.1) +
  geom_hline(yintercept = 0) +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line.x = element_blank(),
        axis.text.x  = element_text(size=14,color="black"),
        axis.text.y  = element_text(size=14,color="black"),
        axis.title.x=element_blank()) +
  xlab("RT(s)") + ylab("NAcc Response (z)") +
  coord_cartesian(ylim=c(-0.25, 1.01)) +
  scale_x_discrete(labels = c('High Bias','Low Bias')) +
  scale_y_continuous(breaks=seq(-0.25,1,0.25)) 
```

#### Interaction between trial-by-trial NAcc activity and motivation-consistent category on participant’s choice 
```{r fig.width = 9, fig.height = 3.5, warnings = F}
BiasedData =  subset(AllData_ValidTrials, Sub %in% SubBias_Striatum$Sub[SubBias_Striatum$medianBehav == "TRUE"])
UnbiasedData = subset(AllData_ValidTrials, Sub %in% SubBias_Striatum$Sub[SubBias_Striatum$medianBehav == "FALSE"])

if (redo_calc) {
  # High Bias Subjects
  res.Striatum.bias = glmer(Choice ~ Cat_n_z + Want2See * accumbens + (Want2See * accumbens|Sub), family = "binomial", BiasedData, control = glmerControl(optimizer = 'bobyqa'))
  
  # Low Bias Subjects      
  res.Striatum.unbias = glmer(Choice ~ Cat_n_z + Want2See * accumbens + (Want2See * accumbens|Sub), family = "binomial", UnbiasedData, control = glmerControl(optimizer = 'bobyqa'))
  
  save(res.Striatum.bias,res.Striatum.unbias, file="long_calc/Striatum_Bias.Rda")

} else {
  load("long_calc/Striatum_Bias.Rda")
}

# High Bias Subjects
summary(res.Striatum.bias)

# Low Bias Subjects
summary(res.Striatum.unbias)
```


```{r fig.width = 9, fig.height = 3.5, warnings = F}
# Extract fixed effects and simulate data
Want2See = c(0,1)
accumbens = seq(-4, 4, len = 100)
Cat_n_z = AllData$Cat_n_z[AllData$Sub == 2013]

pred.data = merge(Want2See,accumbens, by = NULL)
pred.data = merge(pred.data,Cat_n_z,by = NULL)

colnames(pred.data) = c("Want2See", "accumbens", "Cat_n_z")
pred.data$Want2See = as.factor(pred.data$Want2See)

temp = summary(res.Striatum.bias)$coefficients

# Simulate choice 
pred.data$pred_raw = 
  temp['(Intercept)','Estimate'] + 
  temp['Cat_n_z','Estimate'] * pred.data$Cat_n_z +
  temp['Want2See1','Estimate'] * as.numeric(as.character(pred.data$Want2See)) +
  temp['accumbens','Estimate'] * pred.data$accumbens +
  temp['Want2See1:accumbens','Estimate'] * (pred.data$accumbens * as.numeric(as.character(pred.data$Want2See))) 

# Simulate choice probability  
pred.data$pred = 1/(1 + exp(-pred.data$pred_raw))

# High Bias Sub
BiasedData$ChoiceJitter = BiasedData$Choice
BiasedData$ChoiceJitter[as.logical(BiasedData$Choice)] = BiasedData$ChoiceJitter[as.logical(BiasedData$Choice)] - 0.05
BiasedData$ChoiceJitter[!BiasedData$Choice] = BiasedData$ChoiceJitter[!BiasedData$Choice] + 0.05

# Plot High Bias Subject
plot1 = ggplot(BiasedData, aes(x = accumbens, y = ChoiceJitter, col = Want2See)) + 
  geom_jitter(height = 0.05, alpha = 0.2) +
  stat_summary(data = pred.data, aes(x = accumbens, y = pred, col = Want2See), 
               fun.y=mean,geom="line",size=1.5) +
  scale_colour_manual(values=myPalette) +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x  = element_text(size=14,color="black"),
        axis.text.y  = element_text(size=14,color="black"),
        axis.line = element_line(colour = "black"),
        strip.background = element_blank(),
        strip.text.x = element_text(face = "bold"),
        plot.title = element_text(face = "plain", size = (14))) +
  coord_cartesian(ylim=c(0, 1), xlim=c(-4,4)) +
  xlab("NAcc Response (Z)") + ylab("P(Respond Scene)") +
  ggtitle("High Bias")

# Plot Low Bias Subject
UnbiasedData$ChoiceJitter = UnbiasedData$Choice
UnbiasedData$ChoiceJitter[as.logical(UnbiasedData$Choice)] = UnbiasedData$ChoiceJitter[as.logical(UnbiasedData$Choice)] - 0.05
UnbiasedData$ChoiceJitter[!UnbiasedData$Choice] = UnbiasedData$ChoiceJitter[!UnbiasedData$Choice] + 0.05

temp = summary(res.Striatum.unbias)$coefficients

pred.data$pred_raw = 
  temp['(Intercept)','Estimate'] + 
  temp['Cat_n_z','Estimate'] * pred.data$Cat_n_z +
  temp['Want2See1','Estimate'] * as.numeric(as.character(pred.data$Want2See)) +
  temp['accumbens','Estimate'] * pred.data$accumbens +
  temp['Want2See1:accumbens','Estimate'] * (pred.data$accumbens * as.numeric(as.character(pred.data$Want2See))) 
  
pred.data$pred = 1/(1 + exp(-pred.data$pred_raw))

plot2 = ggplot(UnbiasedData, aes(x = accumbens, y = ChoiceJitter, col = Want2See)) +
  geom_jitter(height = 0.05, alpha = 0.2) +
  stat_summary(data = pred.data, aes(x = accumbens, y = pred, col = Want2See),
               fun.y=mean,geom="line",size=1.5) +
  scale_colour_manual(values=myPalette) +
  theme(legend.position="none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x  = element_text(size=14,color="black"),
        axis.text.y  = element_text(size=14,color="black"),
        axis.line = element_line(colour = "black"),
        strip.background = element_blank(),
        strip.text.x = element_text(face = "bold"),
                plot.title = element_text(face = "plain", size = (14))) +
  coord_cartesian(ylim=c(0, 1), xlim=c(-4,4)) +
  xlab("NAcc Response (Z)") + ylab("P(Respond Scene)") +
  ggtitle("Low Bias")

# Combine plots
top_plot = plot_grid(plot.mediansplit,plot1,plot2, labels = c('A','B',''), ncol = 3)
```

### NAcc response is associated with bias in starting point but not drift rate 
```{r fig.width = 9, fig.height = 3.5}
# Load subject parameters
full.model.subj_parm = read.csv("../data/fullmodelsubjparm.csv")
full.model.subj_parm$Sub = as.factor(full.model.subj_parm$Sub)
full.model.subj_parm = left_join(full.model.subj_parm,SubBias_Striatum)
  
# Run GLM
lm.NAcc = summary(lm(scale(accumbens) ~ scale(z) + scale(drift_bias), full.model.subj_parm))
lm.NAcc
lm.NAcc.coef = lm.NAcc$coefficients

# Extract coefficents 
reg_coef = NULL
reg_coef$parm = c('z_bias','v_bias')
reg_coef$value = c(lm.NAcc.coef["scale(z)","Estimate"],lm.NAcc.coef["scale(drift_bias)","Estimate"])
reg_coef$SE = c(lm.NAcc.coef["scale(z)","Std. Error"],lm.NAcc.coef["scale(drift_bias)","Std. Error"])
reg_coef = as.data.frame(reg_coef)
reg_coef$parm = factor(reg_coef$parm, levels = c('z_bias','v_bias'))

# NAcc ~ Z bias + V Bias
plot.reg_coef = ggplot(reg_coef) +
  geom_bar(aes(x = parm, y = value), stat = "identity", width = 0.3) +
  geom_errorbar(aes(x = parm, ymin = value - SE, ymax = value + SE), stat = "identity", width = 0.1) +
      theme(axis.text.x  = element_text(size=14,color="black"),
        axis.text.y  = element_text(size=14,color="black"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=14),
        strip.text.x = element_text(face = "bold", size = 14)) +
  ylab("Estimate") +
  coord_cartesian(ylim=c(-0.2, 0.8))
```

### Increase in NAcc precedes image onset (High Bias participants)
```{r fig.width = 9, fig.height = 8}
# Load NAcc Timecourse
NAcc_tc = read.csv('../data/NAcc_timecourse.csv')
NAcc_tc$Sub = as.factor(NAcc_tc$Sub)
NAcc_tc$MotCon = as.factor(NAcc_tc$MotCon)
NAcc_tc = left_join(NAcc_tc,SubBias_Striatum)

NAcc_tc_summary = group_by(NAcc_tc,MotCon,Time,medianBehav) %>%
  summarise(meanActivity = mean(Activity), se = sem(Activity))

# Convert TR to seconds
NAcc_tc_summary$Time = NAcc_tc_summary$Time * 2

# Plot NAcc Timecourse for High Bias subjects
plot.NACC_tc = ggplot(subset(NAcc_tc_summary, medianBehav == TRUE), 
                      aes(x=Time, y=meanActivity, linetype=MotCon)) +
  geom_line(size = 1.5) +
    theme(legend.position="none",
          axis.text.x  = element_text(size=14,color="black"),
      axis.text.y  = element_text(size=14,color="black"),
      axis.title.x = element_text(size=14),
      axis.title.y = element_text(size=14),
      strip.text.x = element_blank()) +
  geom_errorbar(aes(ymin=meanActivity-se, ymax=meanActivity+se), width=.3) +
  coord_cartesian(ylim=c(-0.12, 0.20)) +
  scale_x_continuous(breaks=seq(-8,8,2)) +
  xlab("Time (s)") + ylab("NAcc Activity (z)")

# Combine plots
bottom_plot = plot_grid(plot.reg_coef, plot.NACC_tc, labels = c('C','D'), rel_widths = c(1,2))
plot_grid(top_plot,bottom_plot,ncol = 1)
```

**NAcc activity is associated with response bias**. **A.** NAcc response to Motivation Consistent trials was higher in High Bias participants than Low Bias participants. **B.** Interaction between trial-by-trial NAcc activity and motivation-consistent category on participant’s choice. Single dots denote individual choices made by participants. Colored lines indicate probability of making a scene categorization as predicted by a linear mixed effects model. For High Bias participants, NAcc activity was more positively associated with making a scene categorization when participants were motivated to see a scene (Blue line) than when participants were motivated to see a face (Red line). There was no relationship between NAcc activity and choice in Low Bias participants. **C.** Linear regression analysis predicting participants’ NAcc response from the model estimates of their starting point bias (zbias) and drift bias (vbias). The regression coefficient for zbias was significant but that for vbias was not. **D.** NAcc timecourse of High Bias participants time-locked to image onset, corrected for hemodynamic lag by shifting the BOLD data by 4 seconds. The trial starts with the “Waiting for Teammate/Opponent” screen at -6s. The teammate or opponent makes a bet at -4s, which remains on the screen for 4s. The image is presented at 0s and stays on screen for 4s. NAcc activity was significantly different between Motivation Consistent trials and Motivation Inconsistent trials from 2s before image onset until image offset. Solid lines: Motivation Consistent trials. Dashed lines: Motivation Inconsistent trials. 